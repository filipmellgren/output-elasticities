library(prodest)
library(data.table)
data(chilean)
head(chilean)

gmm_loss <- function(params, idvar, timevar, output_pred, input) {
  
  degree <- sqrt(length(params) - 1)
  # Step 2: Estimate productivity
  d <- data.table(input)
  d$idvar <- idvar
  d$timevar <- timevar

  d$output_pred <- output_pred
  setnames(d, c("1.0.0", "0.1.0"), c("labor", "capital"))

  d$labor.lag <- lagPanel(idvar, timevar, d$labor)
  d$capital.lag <- lagPanel(idvar, timevar, d$capital)
  
  d$output.lag <- lagPanel(idvar, timevar, d$output_pred)

  d <- na.omit(d)

  prod_vars <- polym(d$labor, d$capital, degree = degree, raw = TRUE)
  d$prod_est <- d$output_pred - prod_vars %*% params

  prod_vars.lag <- polym(d$labor.lag, d$capital.lag, degree = degree, raw = TRUE)
  prodest_lag <- d$output.lag - prod_vars.lag %*% params

  prodest_lag <- polym(prodest_lag, degree = 3, raw = TRUE)

  Z <- polym(d$labor.lag, d$capital, degree = degree, raw = TRUE)
  W <- solve(crossprod(Z)) / nrow(d)

  expected_prod <- fitted(lm(d$prod_est ~ prodest_lag))

  XI <- d$prod_est - expected_prod # Productivity shocks

  crit <- t(crossprod(Z, XI)) %*% W %*% (crossprod(Z, XI))
  
  return(crit)
}

prod_est <- function(output, labor, capital, material, idvar, timevar, degree = 2) {
  input <- polym(labor, capital, material, degree = 2, raw = TRUE)

  first_stage <- lm(output ~ input)
  param0 <- first_stage$coef[c(FALSE, attributes(input)$degree <= degree)]
  param0 <- param0[1:(degree^2 + 1)] + rnorm(degree^2 + 1, 0, 0.01)

  result <- optim(par = param0, fn = gmm_loss,
    idvar = idvar, timevar = timevar,
    output_pred = fitted(first_stage), input = input,
    method = "BFGS")

    return(result)
}

capital <- chilean$sX
labor <- chilean$fX2
material <- chilean$pX
idvar <- chilean$idvar
timevar <- chilean$timevar
degree <- 1
output <- chilean$Y
params <- param0
output_pred <- fitted(first_stage)


# Test ground
# TODO: it works for Cobb Douglas. Test for Translog.
prod_est(chilean$Y, chilean$fX2, chilean$sX, chilean$pX, chilean$idvar, chilean$timevar, degree = 1)

# TODO: names for coefficents and clearer what input is. Also notice I haven't calucalted output elasticities yet.
# TODO: CObb-Douglas case
# use lapply() over groups. 
# TODO: Bootstrap standard errors

prodestACF(chilean$Y, chilean$fX2, chilean$sX, chilean$pX, chilean$idvar, chilean$timevar)

prodestWRDG(chilean$Y, chilean$fX2, chilean$sX, chilean$pX, chilean$idvar, chilean$timevar)
prodestWRDG_GMM(chilean$Y, chilean$fX2, chilean$sX, chilean$pX, chilean$idvar, chilean$timevar)
myestims <- prod_est(chilean$Y, chilean$fX2, chilean$sX, chilean$pX, chilean$idvar, chilean$timevar)

# Y, fX, sX, pX, idvar, timevar
head(polym(capital, labor, degree = 1, raw = TRUE))

polyframe <- data.frame(chilean$fX2, chilean$sX, chilean$pX)
head(model.matrix(~.^2 - 1, data = polyframe))

perform_block_bootstrap <- function(df, num_bootstraps = 1000) {
    n <- nrow(df)
    # Sample with replacement, maintaining block structure
    bootstrap_estimates <- numeric(length = num_bootstraps)
    for (i in 1:num_bootstraps) {
        bootstrap_sample <- df[sample(1:n, replace = TRUE), ]
        bootstrap_estimates[i] <- prod_est(bootstrap_sample,
            "prod_value", "employees", "capital", "input_goods")
        }

    return(bootstrap_estimates)
  }
